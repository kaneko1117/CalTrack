---
alwaysApply: true
---

# マルチエージェント構成ルール

## 概要

このプロジェクトでは `.claude/agents/` にカスタムエージェントが定義されている。
**メインエージェント（Claude）が全てのサブエージェント呼び出しを管理する**マルチエージェント構成を採用。

## アーキテクチャ

```
メインエージェント（Claude）
  │
  ├─→ orchestrator「タスクを処理したい」
  │     ↓
  │   ← 返却「まず design を呼んで」
  │
  ├─→ design 呼び出し
  │     ↓
  │   ← 返却「設計完了」
  │
  ├─→ orchestrator「design の結果はこれ。次は？」
  │     ↓
  │   ← 返却「次は impl を呼んで」
  │
  └─→ ... 繰り返し
```

**重要:**
- サブエージェントは**他のサブエージェントを呼び出さない**
- サブエージェントは**結果を返すだけ**
- **メインがフロー制御を行う**

---

## エージェント一覧

### 司令塔（判断エージェント）

| エージェント | 役割 |
|-------------|------|
| `orchestrator` | タスクを分析し、次に呼び出すべきエージェントを判断して**指示を返すだけ** |

### ワーカーエージェント

| エージェント | 役割 | 入力 | 出力 |
|-------------|------|------|------|
| `design` | 設計作成 | 機能要件、対象層 | 設計ドキュメント |
| `impl` | コード実装 | 設計ドキュメント | 実装ファイル一覧 |
| `test` | Build・Test実行 | 実装ファイル一覧 | テスト結果 |
| `pr` | PR作成 | テスト結果、Issue番号 | PR URL |
| `refactor` | リファクタリング | 対象コード、改善点 | 修正ファイル一覧 |

---

## 使用フロー

### 1. 初回呼び出し

```
メイン → orchestrator: 「Issue #40 を処理したい」
orchestrator → メイン: 「design を呼んで。入力はこれ」
```

### 2. ワーカー呼び出し

```
メイン → design: 「{orchestratorからの入力}」
design → メイン: 「設計完了。結果はこれ」
```

### 3. 継続判断

```
メイン → orchestrator: 「design の結果はこれ。次は？」
orchestrator → メイン: 「ユーザー承認待ち。承認後 impl を呼んで」
```

### 4. ユーザー承認後

```
メイン → ユーザー: 「この設計でよいですか？」
ユーザー → メイン: 「OK」
メイン → impl: 「{設計ドキュメント}」
```

---

## エージェント使用の判断基準

| 依頼内容 | 最初に呼ぶエージェント |
|---------|---------------------|
| 「〇〇機能を実装して」「Issue #XX」 | `orchestrator` |
| 「設計して」 | `design` |
| 「実装して」 | `impl` |
| 「テストして」 | `test` |
| 「PR作って」 | `pr` |
| 「リファクタして」 | `refactor` |

---

## 禁止事項

- サブエージェントが他のサブエージェントを呼び出すこと
- orchestrator のフローを無視して層を飛ばすこと
- 設計エージェントを使わず直接コードを書くこと（簡単な修正を除く）

---

## エージェントの呼び出し方

```
Task tool で該当するエージェントの subagent_type を使用し、
エージェント定義ファイル（.claude/agents/{name}.md）に従って実行する。
```
